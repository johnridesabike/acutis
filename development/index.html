<!DOCTYPE html>
<html lang="en-US">
  <head>
    <title>Acutis development information</title>
    
      <meta name="description" content="Technical details on how Acutis works under the hood." />
    
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <link rel="stylesheet" href="https:&#x2F;&#x2F;johnridesa.bike&#x2F;acutis/style.css" />
    <link rel="icon" href="https:&#x2F;&#x2F;johnridesa.bike&#x2F;acutis/icon.svg" type="image/svg+xml" />
    <link rel="icon" href="https:&#x2F;&#x2F;johnridesa.bike&#x2F;acutis/favicon.ico" />
  </head>
  <body>
    <a class="skip-nav" href="#content">Skip to content.</a><div class="site-header__wrapper">
        <header class="site-header"><p class="site-header__title">
              <a href="https:&#x2F;&#x2F;johnridesa.bike&#x2F;acutis/">
                <img
                  src="https:&#x2F;&#x2F;johnridesa.bike&#x2F;acutis/icon.svg"
                  height="48"
                  width="48"
                  alt="Acutis icon."
                  style="vertical-align:middle;"
                />
                Acutis
              </a>
            </p><p class="site-header__subtitle">A declarative template language for web documents &amp; beyond.</p>
        </header>
        <nav class="site-header__nav">
          <ol class="site-header__nav-list"><li>
                <a href="https:&#x2F;&#x2F;johnridesa.bike&#x2F;acutis&#x2F;" aria-current="false">Home</a>
              </li><li>
                <a href="https:&#x2F;&#x2F;johnridesa.bike&#x2F;acutis&#x2F;introduction&#x2F;" aria-current="false">Getting started</a>
              </li><li>
                <a href="https:&#x2F;&#x2F;johnridesa.bike&#x2F;acutis&#x2F;manual&#x2F;" aria-current="false">Language manual</a>
              </li><li>
                <a href="https:&#x2F;&#x2F;johnridesa.bike&#x2F;acutis&#x2F;api&#x2F;" aria-current="false">API</a>
              </li><li>
                <a href="https:&#x2F;&#x2F;johnridesa.bike&#x2F;acutis&#x2F;playground&#x2F;" aria-current="false">Playground</a>
              </li><li>
                <a href="https:&#x2F;&#x2F;johnridesa.bike&#x2F;acutis&#x2F;development&#x2F;" aria-current="true">Development</a>
              </li><li>
                <a href="https:&#x2F;&#x2F;johnridesa.bike&#x2F;acutis&#x2F;credits&#x2F;" aria-current="false">Credits</a>
              </li></ol>
        </nav>
      </div><main class="main" id="content">
      <article>
          <header class="header">
            <h1>Acutis development information</h1>
          </header><p>The Acutis compiler is built in <a href="https://rescript-lang.org/">ReScript</a> and compiled to JavaScript. The
Acutis compiler’s only dependency is the ReScript standard library, so almost
everything is hand-written.</p>
<p><a href="https://github.com/johnridesabike/acutis">Get the source code</a>.</p>
<p>The compiler follows these basic steps:</p>
<pre><code>source → lexical analysis → abstract syntax tree → render
</code></pre>
<p>Both the abstract syntax tree (AST) and render steps are broken into two
submodules: 1. pattern matching and 2. everything else. We can think of the
language of patterns almost as a sub-language within Acutis. (In fact, I
developed the pattern matching logic before any of the other template logic.)</p>
<p><div class="table-of-contents"><details open><summary class="toc-container-header">Contents</summary><ol><li><a href="#technical-overview">Technical overview</a><ol><li><a href="#types">Types</a></li><li><a href="#lexical-analysis-%2F-tokenization">Lexical analysis / tokenization</a></li><li><a href="#compiling-the-abstract-syntax-tree">Compiling the abstract syntax tree</a></li><li><a href="#rendering">Rendering</a></li></ol></li><li><a href="#rendering-concepts">Rendering concepts</a></li><li><a href="#error-handling">Error handling</a></li><li><a href="#building-the-source">Building the source</a></li><li><a href="#syntax-design">Syntax design</a></li><li><a href="#current-limitations-and-ideas-for-the-future">Current limitations and ideas for the future</a></li></ol></details></div></p>
<h2 id="technical-overview">Technical overview</h2>
<h3 id="types">Types</h3>
<p>Most of the types are defined in <code>Acutis_Types.res</code> along with some of their
utility functions. This includes tokens, AST, pattern AST, and the types of
some of the public API functions.</p>
<p><code>Types</code> is a common module name in ReScript projects. <code>Acutis_Types</code> has that
extra layer of namespace to avoid shadowing when a user <code>open</code>s the <code>Acutis</code>
module.</p>
<h3 id="lexical-analysis-%2F-tokenization">Lexical analysis / tokenization</h3>
<p>Lexical analysis, also called tokenization, is performed in <code>Lexer.res</code>. It
scans the raw source code, one character at a time, and creates low-level
tokens.</p>
<p>The lexer has two basic modes:</p>
<ol>
<li><strong>String mode</strong>. This is the main body of every template. It can parse
echoes and comments, and everything else is read as strings which are
output as-is. (For example, your HTML code.)</li>
<li><strong>Expression mode</strong>. This reads statements, components, patterns, and all
of the other parts of the language.</li>
</ol>
<p>Every template starts in string mode. As soon as the lexer encounters a <code>{%</code>,
it begins expression mode.</p>
<p>All of the tokens are stored in a temporary <a href="https://rescript-lang.org/docs/manual/latest/api/belt/mutable-queue"><code>Belt.MutableQueue.t</code></a>
structure.</p>
<h3 id="compiling-the-abstract-syntax-tree">Compiling the abstract syntax tree</h3>
<p>The tokens compile into the AST with <code>Compile.res</code>. The functions in this
module inspect each token in the queue and create nodes for the AST.</p>
<p>This compiler has a submodule for compiling patterns. This is only exposed
for testing purposes.</p>
<p>The AST is represented as an array of nodes. Some nodes, such as <code>map</code> or
<code>match</code> expressions, contain arrays that represent branching paths of the
tree.</p>
<p>Template components are linked at compile-time to create a <a href="https://en.wikipedia.org/wiki/Directed_acyclic_graph">directed acyclic
graph</a>.</p>
<p>When compiling template components, you must compile them all at once with
<code>Compile.Components.make</code> so the linking can occur.</p>
<p>When compiling a top-level template, <code>Compile.make</code> requires a
<code>Compile.Components.t</code> value (created with <code>Components.make</code>) to link its
dependencies.</p>
<h3 id="rendering">Rendering</h3>
<p>The <code>Environment.res</code> module contains functions for producing specific output
formats. These functions use the <code>Render.res</code> module to take the AST and the
input “props” to produce the final output.</p>
<p>Like <code>Compile.res</code>, <code>Render.res</code> exposes a submodule for rendering patterns.</p>
<p>You may expect the renderer to produce a string data type. However, the
output could theoretically be anything defined in the environment. I designed
this flexibility specifically for <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise">Promises</a>.</p>
<p>When the renderer processes a node, it adds the result to a queue. Once it
renders the entire AST, it concatenates the queue into the final output.</p>
<p>If we’re processing templates synchronously, then the queue is filled with
strings and the output is a string.</p>
<p>If we’re processing templates asynchronously, then the queue is filled with
promises of strings. They are resolved with <code>Promise.all</code> and then
concatenated.</p>
<h2 id="rendering-concepts">Rendering concepts</h2>
<p>Acutis relies on recursive function types to render.</p>
<ol>
<li>The environment with a render function:
<code>env.render(ast, props, children) → result</code></li>
<li>The template functions with this signature:
<code>template(env, props, children) → result</code></li>
</ol>
<p>The <code>env</code> argument in 2 is the same <code>env</code> record as in 1.
The <code>ast</code> in 1 can also contain template functions like in 2, which
themselves render template components using the <code>env</code> from 1.</p>
<p>The <code>env</code> record contains the <code>render</code> function with the logic that must be
global across the entire template tree. Specifically, it controls whether to
output synchronously or asynchronously. This is why there are two render
environments.</p>
<ol>
<li><code>Environment.sync.render(ast, props, children) → result</code></li>
<li><code>Environment.async.render(ast, props, children) → Promise&lt;result&gt;</code></li>
</ol>
<p>Suppose you have a root template, <code>template</code>, which you render like this:
<code>template(env, props, children)</code>. What happens is:</p>
<ol>
<li>The <code>template</code> function takes the <code>render</code> function from <code>env</code> and
executes it with <code>props</code>, <code>children</code>, and the AST.</li>
<li>The <code>render</code> function recursively iterates through the AST and renders
each node with the <code>props</code> and <code>children</code>. Each result is enqueued.</li>
<li>If the <code>render</code> function encounters a template component, which is just
another template function, <code>x</code>, it executes <code>x(env, props, children)</code>,
beginning a new loop at step 1. Here, <code>x</code> is the component, <code>render</code> is
the same (recursive) render environment, and <code>props</code> and <code>children</code> are
both taken from the same AST node as <code>x</code>. The result of this is enqueued
in the original queue.</li>
<li>Steps 2 and 3 repeat until the renderer has traversed the entire AST.</li>
<li>The queue of results is concatenated and returned as the final result.</li>
</ol>
<h2 id="error-handling">Error handling</h2>
<p>Acutis shouldn’t raise exceptions or reject promises. The AST and the
rendered output is always returned inside of a variant that can return either
successfully rendered data or an array of errors. If there are any errors,
then they’re formatted according to the <code>Acutis_Types.Errors.t</code> type.</p>
<p>The <code>Debug.res</code> file handles creating the specific messages.</p>
<p>The lexer and compiler both stop as soon as they encounter an error. The
renderer will always transverse as much of the AST as possible and report all
of the errors it finds.</p>
<p>Acutis will not return partially-rendered content alongside errors.</p>
<h2 id="building-the-source">Building the source</h2>
<p>The source files are in <code>.res</code>, ReScript, format. You can compile them with
the command <code>yarn build</code>, or compile in watch mode with <code>yarn start</code>. This
will generate <code>.js</code> files alongside the source.</p>
<p>You can test your changes with <code>yarn test</code> or <code>yarn test:watch</code> for watch
mode. This tests the generated JavaScript files.</p>
<h2 id="syntax-design">Syntax design</h2>
<p>I designed Acutis’ syntax to build on the work of existing conventions in
similar languages as much as possible.</p>
<p>I borrowed the <code>{{</code> “mustache” <code>}}</code> syntax from the titular Mustache
language.</p>
<p>I borrowed the <code>{%</code> expression <code>%}</code> syntax from Liquid and Jinja.</p>
<p>I borrowed the pattern syntax from ReScript, which is really borrowed from
both JavaScript and OCaml.</p>
<p>I borrowed the <code>{% Component x=y %} z {% /Component %}</code> syntax from React
JSX. Like JSX, this is just syntax for a function call.</p>
<p>I designed the language so different parts will look as unambiguous as
possible. An identifier like <code>x</code> will always be a binding. An expression that
begins like <code>{% Abc</code> will always be a component. <code>{{ Xyz }}</code> will always be a
template child. This makes parsing easier, for both humans and computers.</p>
<p>I chose the <code>#</code> “template section” <code>/#</code> syntax, as in
<code>{% Abc Xyz=#%} hi {%/# /%}</code>, because I thought of the section contents as
“blocks,” and <code>#</code> kind of looks like a block. It is also semantically neutral
compared to most alternatives. I ruled out <code>{</code> and <code>}</code> because
<code>{% Abc Xyz={%} hi {%} /%}</code> just looks confusing. The curly braces are
already doing too much work.</p>
<h2 id="current-limitations-and-ideas-for-the-future">Current limitations and ideas for the future</h2>
<p>I made Acutis strongly typed because this catches errors early and makes
fixing bugs easier. Acutis is dynamically typed (where types are checked at
runtime), but I think of Acutis templates as theoretically statically typed
(where types are checked at compile time). However, that would require adding
another step in the compiler.</p>
<p>I borrowed the types themselves from JSON. This was convenient and “good
enough,” even though JSON is imperfect. A more flexible and robust set of
types would be nice to have.</p>
<p>I designed the language to be as simple as possible, with the philosophy of
“there should be one obvious way to do something.” For this reason, I’ve
excluded some utility features such as <code>if</code>…<code>else</code> statements and direct
access of object and array items. These can be achieved through pattern
matching instead, although that may be slightly more verbose. I’m not opposed
to adding these features in the future if there is a need which justifies
their maintenance.</p>
<p>Props, template children, and template components each live in separate
“layers” of the language due to their internal type differences. This feels
like a leaky implementation detail though, and theoretically it would be nice
if they could all coexist in one single <code>props</code> object for each template.</p>
<p>I have only done minimal performance measurements. In the “make it work, make
it right, make it fast,” order, performance comes last.</p>

      </article>
    </main><footer class="footer">
  <p>
    Published in 2021 by <a href="https:&#x2F;&#x2F;johnridesa.bike">John Jackson</a>.
  </p>
  <p class="footer__license">
    <a href="https:&#x2F;&#x2F;johnridesa.bike&#x2F;acutis/license/">View the license</a>.
  </p>
</footer>
</body>
</html>